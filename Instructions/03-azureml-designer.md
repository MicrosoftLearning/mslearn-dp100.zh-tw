---
lab:
  title: 使用 Azure Machine Learning 設計工具
ms.openlocfilehash: 3bfe1bf2e119c295ad3931c569e1f09b41bb2174
ms.sourcegitcommit: 38540a481d1dfa9bab570777b72e3cf9b6ee6da7
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 12/16/2021
ms.locfileid: "145195743"
---
# <a name="use-azure-machine-learning-designer"></a>使用 Azure Machine Learning 設計工具

Azure Machine Learning *設計工具* 提供了一個能夠拖放檔案的環境，讓您可以在其中定義工作流程，或是資料擷取、轉換和模型定型模組的 *管線*，以建立機器學習模型。 您可以接著將此管線發佈為 Web 服務，讓用戶端應用程式可用來進行 *推斷* (從新資料產生預測)。

## <a name="before-you-start"></a>開始之前

若您尚未這樣做，請先完成 *[建立 Azure Machine Learning 工作區](01-create-a-workspace.md)* 練習，以建立 Azure Machine Learning 工作區與計算執行個體，並複製本練習所需的筆記本。

## <a name="configure-compute-resources"></a>設定計算資源

若要使用 Azure Machine Learning 設計工具，您需要能夠執行模型定型實驗的計算。

1. 使用與 Azure 訂用帳戶相關聯的 Microsoft 認證登入 [Azure Machine Learning 工作室](https://ml.azure.com?azure-portal=true)，然後選取您的 Azure Machine Learning 工作區。
2. 在 Azure Machine Learning 工作室中，檢視工作區的 [計算] 頁面，然後在 [計算執行個體] 索引標籤上，如果計算執行個體尚未執行，請啟動計算執行個體。 您將使用此計算執行個體來測試已定型的模型。
3. 在計算執行個體開始啟動時，切換至 [計算叢集] 索引標籤。如果您尚未擁有計算叢集，請以下列設定新增一個計算叢集。 您將使用此叢集來執行定型管線。
    - **區域**：*與您的工作區區域相同*
    - **虛擬機器優先順序**：專用
    - **虛擬機器類型**：CPU
    - **虛擬機器大小**：Standard_DS11_v2
    - **計算名稱**：輸入唯一的名稱
    - **節點數目下限**：0
    - **節點數目上限**：2
    - **縮小前的閒置秒數**：120
    - **啟用 SSH 存取**：未選取

## <a name="review-the-training-dataset"></a>檢閱定型資料集

現在既然您有可用來執行定型管線的計算資源，您會需要一些資料來定型模型。

1. 在 Azure Machine Learning 工作室中，檢視 [資料集] 頁面。 資料集代表您計劃在 Azure ML 中使用的特定資料檔案或資料表。
2. 如果您先前已建立 **糖尿病資料集** 資料集，請開啟。 否則，請使用下列設定，從 Web 檔案建立新的資料集並開啟：
    * **基本資訊**：
        * **Web URL**：https://aka.ms/diabetes-data
        * **名稱**：糖尿病資料集
        * **資料集類型**：表格式
        * **描述**：糖尿病資料
    * **設定和預覽**：
        * **檔案格式**：分隔
        * **分隔符號**：逗號
        * **編碼**：UTF-8
        * **資料行標頭**：使用來自第一個檔案的標頭
        * **跳過資料列**：無
    * **結構描述**：
        * 包含 [路徑] 以外的所有資料行
        * 檢閱自動偵測到的類型
    * **確認詳細資料**：
        * 請不要在建立後分析資料集

4. 檢視 [探索] 頁面以查看資料的範例。 此資料呈現了已測試糖尿病病患的詳細資料，而您要使用這些資料來定型模型，藉此根據臨床測量來預測病患測試得到糖尿病的可能性。

## <a name="create-a-designer-pipeline"></a>建立設計工具管線

若要開始使用設計工具，您必須先建立管線，並新增您要使用的資料集。

1. 在 Azure Machine Learning 工作室中，檢視 [設計工具] 頁面並建立新管線。
2. 按一下預設名稱 (或按一下管線名稱旁的 **&#9881;** 圖示)，將預設管線名稱 (**Pipeline-Created-on-* date***) 變更為 **視覺化糖尿病定型**
3. 請注意，您必須指定要對其執行管線的計算目標。 在 [設定] 窗格中，按一下 [選取計算目標]，然後選取計算叢集。
4. 在設計工具的左側，展開 [資料集] 區段，然後將 [糖尿病資料集] 資料集拖曳至畫布。
5. 選取畫布上的 [糖尿病資料集]模組。 然後以滑鼠右鍵按一下，再選取 [預覽資料]。
6. 在 [資料集輸出] 窗格中，選取 [設定檔] 索引標籤。
7. 檢查資料的結構描述，請注意，各種資料行的分佈會以長條圖表示。 關閉視覺效果。

## <a name="add-transformations"></a>新增轉換

一般而言，您必須先對資料套用一些前置處理轉換，才可為模型定型。

1. 在左側窗格中，展開 [資料轉換] 區段，其中包含在模型定型前可用來轉換資料的各種模組。
2. 將 [正規化資料] 模組拖曳至畫布，放在 [糖尿病資料集] 模組底下。 然後將 [糖尿病資料集] 模組的輸出連線到 [正規化資料] 模組的輸入。
3. 選取 **Normalize Data** (正規化資料) 模組並檢視其設定，請注意，您必須指定轉換方法和要轉換的資料行。 然後，將轉換保持在 **ZScore** 不變，並編輯資料行以包含下列資料行名稱：
    * PlasmaGlucose
    * DiastolicBloodPressure
    * TricepsThickness
    * SerumInsulin
    * BMI
    * DiabetesPedigree

    **注意**：我們要將數值資料行以同等規模正規化，避免數值較大的資料行主導模型訓練。 通常會套用像這樣的一系列前置處理轉換，為您的資料進行定型的準備，但在此練習中，我們會將內容簡化。

4. 現在，我們已準備好將資料分割成不同的資料集，以進行定型和驗證。 在左側窗格中，於 [資料轉換] 區段中，將 [分割資料] 模組拖曳至 [正規化資料] 模組底下的畫布。 然後將 **Normalize Data** (正規化資料) 模組的 [已轉換的資料集] 輸出 (左側) 連線到 **Split Data** (分割資料) 模組的輸入。
5. 選取 **Split Data** (分割資料) 模組，如下設定其設定：
    * **分割模式**：分割資料列
    * **第一個輸出資料集中的資料列比例**：0.7
    * **隨機種子**：123
    * **分層的分割**：不正確

## <a name="add-model-training-modules"></a>新增模型定型模組

備妥資料並分割成定型和驗證資料集之後，您就可以設定管線來定型和評估模型。

1. 展開左側窗格中的 [定型模型] 區段，然後將 **Train Model** (定型模型) 模組拖曳至 **Split Data** (分割資料) 模組下的畫布上。 然後將 **Split Data** (分割資料) 模組的 *Result dataset1* (左側) 輸出連線至 **Train Model** (定型模型) 模組的「資料集」(右側) 輸入。
2. 我們要定型的模型會預測 [糖尿病] 值，因此請選取 [定型模型] 模組並修改其設定，將 [標籤資料行] 設定為 [糖尿病] (大小寫和拼字都要完全符合！)
3. 模型將預測的 **糖尿病** 標籤是一個二進位資料行 (1 表示罹患糖尿病的病患，0 表示沒有患病的病患)，因此我們需要使用 *分類* 演算法來定型模型。 展開 [機器學習演算法] 區段，然後在 [分類] 底下，將 [二級羅吉斯迴歸] 模組拖曳至畫布上，放在 [分割資料] 模組左側，[定型模型] 模組上方。 然後將其輸出連線至 **Train Model** (定型模型) 模組的 **未定型的模型** (左側) 輸入。
4. 若要測試定型的模型，必須用此模型來評分分割原始資料時所保留的驗證資料集。 展開 [模型評分與評估] 區段，並將 **Score Model** (評分模型) 模組拖曳至 **Train Model** (定型模型) 模組下方的畫布上。 然後將 **Train Model** (定型模型) 模組的輸出連線到 **Score Model** (評分模型) 模組的 **定型模型** (左側) 輸入，將 **Split Data** (分割資料) 模組的 **Results dataset2** (右側) 輸出拖曳到 **Score Model** (評分模型) 模組的 **資料集** (右側) 輸入。
5. 若要評估模型的執行狀況，我們需要查看一些透過評分驗證資料集所產生的計量。 將 [評估模型] 模組從 [模型評分與評估] 區段拖曳至 [評分模型] 模組底下的畫布，並將 [評分模型] 模組的輸出連線至 [評估模型] 模組的 [評分資料集] (左側) 輸入。

## <a name="run-the-training-pipeline"></a>執行定型管線

定義資料流程步驟之後，您現在可以開始執行定型管線並定型模型。

1. 驗證管線是否類似下列

    ![視覺化定型管線](images/visual-training.jpg)

2. 按一下右上方的 [提交]。 接著在出現提示時，請建立名為 **mslearn-designer-train-diabetes** 的新實驗，然後加以執行。  這會在初始化計算叢集後執行管線，可能需要 10 分鐘或更長的時間進行。 您可以在設計畫布右上方看到管線執行的狀態。

    > **秘訣**：如果發生 **GraphDatasetNotFound** 錯誤，請選取資料集並在其 [屬性] 窗格中，變更 [版本] (您可以在 [一律使用最新] 和 [1] 之間切換)，然後重新執行管線。
    >
    > 執行時，您可以檢視已在 [管線] 和 [實驗] 頁面中建立的管線和實驗。 當您完成時，切換回 [設計工具] 頁面上的 [視覺化糖尿病定型] 管線。

3. 在 [正規化資料] 模組完成後請選取，然後在 [設定] 窗格中，[輸出 + 記錄] 索引標籤 [轉換資料集] 區段內的 [資料輸出] 底下，按一下 [預覽資料] 圖示，這時您可以檢視已轉換資料行的統計資料和分佈視覺效果。
4. 關閉 [正規化資料] 視覺效果，並等候其餘模組完成。 接著將 [評估模型] 模組的輸出視覺化，以查看模型的計量。

    **注意**：此模型的效能不盡理想，部分原因是我們僅執行了最基本的特徵工程和前置處理。 您可以試著使用不同的分類演算法，並比較結果 (您可以將 [分割資料] 模組的輸出連線至多個 [定型模型] 和 [評分模型] 模組，也可以再將另一個已評分的模型連線至 [評估模型] 模組，以兩相比較)。 本練習的重點是介紹設計工具介面，而不是定型出完美的模型！

## <a name="create-an-inference-pipeline"></a>建立推斷管線

既然您已使用過 *定型管線* 來定型模型，您可以建立 *推斷管線*，以使用定型的模型來預測新資料的標籤。

1. 在 [Create inference pipeline] (建立推斷管線) 下拉式清單中，按一下 [Real-time inference pipeline] (即時推斷管線)。 幾秒鐘後，就會開啟名為 **視覺化糖尿病定型 - 即時推斷** 的新版管線。
2. 將新管線重新命名為 **Predict Diabetes**，然後檢閱新的管線。 請注意，此管線封裝了正規化轉換和已定型模型，因此訓練資料中的統計資料會用來正規化所有新資料值，而定型的模型則會用來對新資料評分。
3. 請注意推斷管線假設新資料會符合原始訓練資料的結構描述，因此會包含來自訓練管線的 **糖尿病資料集** 資料集。 不過，此輸入資料包含模型所預測的 [糖尿病] 標籤，而難以直接納入尚未進行糖尿病預測的新患者資料中。
4. 從推斷管線中刪除 [糖尿病資料集] 資料集，並在 [資料輸入和輸出] 區段取代為 [手動輸入資料] 模組；接著作為 [Web 服務輸入] 連接到與 [套用轉換] 模組相同的 **資料集** 輸入端。 然後修改 [手動輸入資料] 模組的設定，以使用下列 CSV 輸入，其中包含了不帶標籤的三個新病患觀察的特徵值：

```CSV
PatientID,Pregnancies,PlasmaGlucose,DiastolicBloodPressure,TricepsThickness,SerumInsulin,BMI,DiabetesPedigree,Age
1882185,9,104,51,7,24,27.36983156,1.350472047,43
1662484,6,73,61,35,24,18.74367404,1.074147566,75
1228510,4,115,50,29,243,34.69215364,0.741159926,59
```

5. 推斷管線包含 **Evaluate Model** (評估模型) 模組，因為這在使用新資料預測時沒什麼用處，所以請刪除此模組。
6. [評分模型] 模組的輸出包含所有輸入特徵，以及預測的標籤和機率分數。 若要將輸出限制為只有預測和機率，請刪除 [評分模型] 模組與 [Web 服務輸出] 之間的連線，從 [Python 語言] 區段新增 [執行 Python 指令碼] 模組，將 [評分模型] 模組的輸出連線至 [資料集 1] (最左邊) [執行 Python 指令碼] 的輸入端，並將 [執行 Python 指令碼] 模組的輸出連接到 [Web 服務輸出]。 然後修改 [執行 Python 指令碼] 模組的設定，以使用下列程式碼 (取代所有現有的程式碼)：

```Python
import pandas as pd

def azureml_main(dataframe1 = None, dataframe2 = None):

    scored_results = dataframe1[['PatientID', 'Scored Labels', 'Scored Probabilities']]
    scored_results.rename(columns={'Scored Labels':'DiabetesPrediction',
                                    'Scored Probabilities':'Probability'},
                            inplace=True)
    return scored_results
```
> **注意**：在 [執行 Python 指令碼] 模組中貼上程式碼之後，請確認程式碼看起來與上述程式碼類似。 縮排在 Python 中相當重要，如果縮排未正確複製，模組將會失敗。 

7. 驗證管線是否類似下列

    ![視覺化推斷管線](images/visual-inference.jpg)

9. 在用於定型的計算叢集上，將管線提交為名為 **mslearn-designer-predict-diabetes** 的新實驗。 這可能需要一會兒！

## <a name="deploy-the-inference-pipeline-as-a-web-service"></a>將推斷管線部署為 Web 服務

現在您有了能進行即時推斷的推斷管線，可將其部署為 Web 服務以供用戶端應用程式使用。

> **注意**：在此練習中，您會將 Web 服務部署到 Azure 容器執行個體 (ACI)。 此類型的計算是動態建立的，而且適用於開發及測試。 針對生產環境，您應該建立 *推斷叢集*，該叢集提供可提供更佳可擴縮性與安全性的 Azure Kubernetes Service (AKS) 叢集。

1. 如果 **預測糖尿病** 推斷管線尚未完成執行，請等候完成。 然後將 **執行 Python 指令碼** 模組的結果 **資料集** 輸出視覺化，以查看輸入資料中三個病患觀察的預測標籤和機率。
2. 在右上方，按一下 [部署]，然後使用下列設定部署新的即時端點：
    -  **名稱**：designer-predict-diabetes
    -  **描述**：預測糖尿病。
    - **計算類型**：Azure 容器執行個體
3. 等待系統部署 Web 服務 - 這可能需要幾分鐘。 部署狀態會顯示在設計工具介面的左上方。

## <a name="test-the-web-service"></a>測試 Web 服務

現在，您可以從用戶端應用程式測試已部署的服務 - 在此案例中，您將使用筆記本。

1. 在 [端點] 頁面中，開啟 **designer-predict-diabetes** 即時端點。
2. 當 **designer-predict-diabetes** 端點開啟時，請在 [取用] 索引標籤上，記下 **REST 端點** 和 **主索引鍵** 的值。
3. 在瀏覽器中開啟 **desinger-predict-diabetes** 服務頁面的 [取用] 頁面之後，就會開啟新的瀏覽器索引標籤，並開啟 Azure Machine Learning 工作室的另一個執行個體。 然後您就可以在新的索引標籤中，檢視 [筆記本] 頁面。
4. 在 [筆記本] 頁面的 [我的檔案] 下，瀏覽至您複製筆記本存放庫的 **/users/*您的使用者名稱*/mslearn-dp100** 資料夾，然後開啟 [取得設計工具預測] 筆記本。
5. 開啟了筆記本之後，請務必在 [計算] 方塊中選取先前建立的計算執行個體，且其狀態為 [執行中]。
6. 在筆記本中，將 **ENDPOINT** 和 **PRIMARY_KEY** 預留位置取代為您服務的值，您可以從端點頁面上的 [取用] 索引標籤上複製。
7. 執行程式碼儲存格，並檢視 Web 服務所傳回的輸出。

## <a name="clean-up"></a>清除

您建立的 Web 服務會裝載在 *Azure 容器執行個體* 中。 如果不打算進一步試驗此服務，則應刪除端點，以避免產生不必要的 Azure 使用量。 您也應該停止計算執行個體，直到再次需要為止。

1. 在 Azure Machine Learning 工作室的 [端點] 索引標籤上，選取 **predict-diabetes** 端點。 然後按一下 [刪除] (&#128465;) 按鈕，並確認您要刪除該端點。
2. 如果您已完成在 Azure Machine Learning 上的作業，請在 [計算執行個體] 索引標籤上選取計算執行個體，然後按一下 [停止] 以將其關閉。

> **注意**：停止您的計算可確保您的訂用帳戶不需支付計算資源的費用。 不過，只要您的訂用帳戶中有 Azure Machine Learning 工作區，您就必須為了資料儲存空間支付少量的費用。 如果您已完成探索 Azure Machine Learning，則可刪除包含 Azure Machine Learning 工作區及其相關的資源群組。 不過，如果您打算完成此系列的任何其他實驗室，必須要重複 *[建立 Azure Machine Learning 工作區](01-create-a-workspace.md)* 練習，以先建立工作區並準備好環境。
